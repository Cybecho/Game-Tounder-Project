// âš¡ Electric Skill System - ì „ê¸° ê´€ë ¨ ìŠ¤í‚¬ë“¤
export class ElectricSkillSystem {
    constructor(gameScene) {
        this.game = gameScene;
        this.activeRandomLightning = null;
        this.lightningStrikeCount = 0;
    }
    
    // ì „ê¸° ì²´ì¸ ê³µê²© ìŠ¤í‚¬ (50% í™•ë¥ , ìµœëŒ€ 3íšŒ ì „ì´)
    triggerElectricChain(hitEnemy, skillLevel = 1) {
        // 50% í™•ë¥  ì²´í¬
        if (Math.random() > 0.5) {
            return false;
        }
        
        if (!hitEnemy || !hitEnemy.active) {
            return false;
        }
        
        console.log(`âš¡ ì „ê¸° ì²´ì¸ ë°œë™! ë ˆë²¨: ${skillLevel}, ì‹œì‘ì : ${hitEnemy.enemyType || 'unknown'}`);
        
        // ì²´ì¸ ë¼ì´íŠ¸ë‹ ì‹œìŠ¤í…œì´ ìˆëŠ”ì§€ í™•ì¸
        if (!this.game.chainLightningSystem) {
            console.warn('âš ï¸ ChainLightningSystemì´ ì—†ì–´ì„œ ì „ê¸° ì²´ì¸ ì‹¤í–‰ ë¶ˆê°€');
            return false;
        }
        
        // ìŠ¤í‚¬ ë ˆë²¨ì— ë”°ë¥¸ ì„¤ì • ì¡°ì •
        const chainConfig = {
            maxJumps: Math.min(3, skillLevel + 2), // ìµœëŒ€ 3íšŒ ì „ì´ (ë ˆë²¨ì—…ì‹œ ì¦ê°€)
            maxRange: 150 + (skillLevel * 25), // ë ˆë²¨ë‹¹ ë²”ìœ„ ì¦ê°€
            damage: 8 + (skillLevel * 2), // ë ˆë²¨ë‹¹ ë°ë¯¸ì§€ ì¦ê°€
            damageDecay: 0.85, // ì•½ê°„ ë” ë³´ì¡´ì ì¸ ë°ë¯¸ì§€ ê°ì†Œ
            duration: 120 // ì•½ê°„ ë¹ ë¥¸ ì²´ì¸
        };
        
        // ì²´ì¸ ì‹¤í–‰
        const success = this.game.chainLightningSystem.executeChainLightning(\n            hitEnemy,\n            hitEnemy.x,\n            hitEnemy.y,\n            chainConfig\n        );
        
        if (success) {
            // ìŠ¤í‚¬ ë°œë™ ì‹œê°ì  í‘œì‹œ
            this.showElectricChainActivation(hitEnemy.x, hitEnemy.y, skillLevel);
        }
        
        return success;
    }
    
    // ëœë¤ ë²ˆê°œ ë‚´ë¦¬ì¹˜ê¸° ìŠ¤í‚¬ (ì¤‘ì²©í˜•, ìµœëŒ€ 3íšŒ)
    activateRandomLightning(skillLevel = 1, duration = 15000) {
        console.log(`ğŸŒ©ï¸ ëœë¤ ë²ˆê°œ í™œì„±í™”! ë ˆë²¨: ${skillLevel}, ì§€ì†ì‹œê°„: ${duration}ms`);
        
        // ê¸°ì¡´ ëœë¤ ë²ˆê°œê°€ ìˆë‹¤ë©´ ì •ë¦¬
        if (this.activeRandomLightning) {
            this.activeRandomLightning.destroy();\n        }\n        
        // ìŠ¤í‚¬ ë ˆë²¨ì— ë”°ë¥¸ ì„¤ì •
        const lightningConfig = {\n            level: skillLevel,\n            strikeInterval: Math.max(1000, 3000 - (skillLevel * 500)), // ë ˆë²¨ë‹¹ ë” ìì£¼ (1ì´ˆ~3ì´ˆ)\n            strikesPerWave: skillLevel, // ë ˆë²¨ë‹¹ ë™ì‹œ ë²ˆê°œ ìˆ˜ ì¦ê°€\n            damage: 12 + (skillLevel * 3), // ë ˆë²¨ë‹¹ ë°ë¯¸ì§€ ì¦ê°€\n            range: 80 + (skillLevel * 20) // ë ˆë²¨ë‹¹ ë²”ìœ„ ì¦ê°€\n        };\n        \n        let remainingTime = duration;\n        \n        // ëœë¤ ë²ˆê°œ íƒ€ì´ë¨¸ ì‹œì‘\n        this.activeRandomLightning = this.game.time.addEvent({\n            delay: lightningConfig.strikeInterval,\n            callback: () => {\n                if (this.game.player && this.game.player.active && !this.game.isSkillSelectionActive) {\n                    this.executeRandomLightningStrike(lightningConfig);\n                }\n                \n                remainingTime -= lightningConfig.strikeInterval;\n                if (remainingTime <= 0) {\n                    console.log('ğŸŒ©ï¸ ëœë¤ ë²ˆê°œ ì§€ì†ì‹œê°„ ì¢…ë£Œ');\n                    if (this.activeRandomLightning) {\n                        this.activeRandomLightning.destroy();\n                        this.activeRandomLightning = null;\n                    }\n                }\n            },\n            repeat: Math.floor(duration / lightningConfig.strikeInterval)\n        });\n        \n        // ìŠ¤í‚¬ í™œì„±í™” ì‹œê°ì  í‘œì‹œ\n        this.showRandomLightningActivation(skillLevel, duration);\n        \n        return true;\n    }\n    \n    // ê°œë³„ ë²ˆê°œ ë‚´ë¦¬ì¹˜ê¸° ì‹¤í–‰\n    executeRandomLightningStrike(config) {\n        const strikesThisWave = config.strikesPerWave;\n        \n        for (let i = 0; i < strikesThisWave; i++) {\n            // ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ë‘ê³  ë²ˆê°œ ë°œìƒ\n            this.game.time.delayedCall(i * 100, () => {\n                this.createSingleLightningStrike(config);\n            });\n        }\n    }\n    \n    // ë‹¨ì¼ ë²ˆê°œ ë‚´ë¦¬ì¹˜ê¸° ìƒì„±\n    createSingleLightningStrike(config) {\n        // ëœë¤ ìœ„ì¹˜ ì„ íƒ (í”Œë ˆì´ì–´ ì£¼ë³€ ë˜ëŠ” ì ì´ ë§ì€ ê³³)\n        const strikePos = this.selectOptimalStrikePosition(config.range * 3);\n        \n        if (!strikePos) return;\n        \n        this.lightningStrikeCount++;\n        \n        console.log(`âš¡ ë²ˆê°œ ë‚´ë¦¬ì¹˜ê¸° #${this.lightningStrikeCount}: (${Math.round(strikePos.x)}, ${Math.round(strikePos.y)})`);\n        \n        // ë²ˆê°œ ê²½ê³  íš¨ê³¼ (0.5ì´ˆ ì „)\n        this.createLightningWarning(strikePos.x, strikePos.y);\n        \n        // 0.5ì´ˆ í›„ ì‹¤ì œ ë²ˆê°œ ë°œìƒ\n        this.game.time.delayedCall(500, () => {\n            this.createLightningStrike(strikePos.x, strikePos.y, config);\n        });\n    }\n    \n    // ìµœì  ë²ˆê°œ ìœ„ì¹˜ ì„ íƒ\n    selectOptimalStrikePosition(searchRadius) {\n        const playerX = this.game.player.x;\n        const playerY = this.game.player.y;\n        \n        // ê·¼ì²˜ ì ë“¤ ì°¾ê¸°\n        const nearbyEnemies = [];\n        this.game.enemies.children.entries.forEach(enemy => {\n            if (enemy.active) {\n                const distance = Phaser.Math.Distance.Between(\n                    playerX, playerY, enemy.x, enemy.y\n                );\n                if (distance <= searchRadius) {\n                    nearbyEnemies.push({\n                        enemy: enemy,\n                        distance: distance\n                    });\n                }\n            }\n        });\n        \n        if (nearbyEnemies.length === 0) {\n            // ì ì´ ì—†ìœ¼ë©´ í”Œë ˆì´ì–´ ì£¼ë³€ ëœë¤ ìœ„ì¹˜\n            const angle = Math.random() * Math.PI * 2;\n            const distance = 100 + Math.random() * 200;\n            return {\n                x: playerX + Math.cos(angle) * distance,\n                y: playerY + Math.sin(angle) * distance\n            };\n        }\n        \n        // ì ë“¤ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ (ê°€ê¹Œìš´ ì ì—ê²Œ ê°€ì¤‘ì¹˜)\n        const totalWeight = nearbyEnemies.reduce((sum, item) => {\n            const weight = Math.max(1, searchRadius - item.distance);\n            return sum + weight;\n        }, 0);\n        \n        let randomValue = Math.random() * totalWeight;\n        for (let item of nearbyEnemies) {\n            const weight = Math.max(1, searchRadius - item.distance);\n            randomValue -= weight;\n            if (randomValue <= 0) {\n                return {\n                    x: item.enemy.x + (Math.random() - 0.5) * 60, // ì•½ê°„ì˜ ëœë¤ì„±\n                    y: item.enemy.y + (Math.random() - 0.5) * 60\n                };\n            }\n        }\n        \n        // í´ë°±: ì²« ë²ˆì§¸ ì  ìœ„ì¹˜\n        const firstEnemy = nearbyEnemies[0].enemy;\n        return {\n            x: firstEnemy.x,\n            y: firstEnemy.y\n        };\n    }\n    \n    // ë²ˆê°œ ê²½ê³  íš¨ê³¼\n    createLightningWarning(x, y) {\n        // ë¶‰ì€ ì›í˜• ê²½ê³ \n        const warning = this.game.add.circle(x, y, 40, 0xff4444, 0.3);\n        warning.setStrokeStyle(3, 0xff0000, 0.8);\n        \n        // ê¹œë¹¡ì´ëŠ” íš¨ê³¼\n        this.game.tweens.add({\n            targets: warning,\n            alpha: 0.1,\n            duration: 250,\n            yoyo: true,\n            repeat: 1,\n            onComplete: () => warning.destroy()\n        });\n    }\n    \n    // ì‹¤ì œ ë²ˆê°œ ë‚´ë¦¬ì¹˜ê¸°\n    createLightningStrike(x, y, config) {\n        // ë²ˆê°œ ì‹œê° íš¨ê³¼\n        this.createLightningStrikeEffect(x, y);\n        \n        // ë²”ìœ„ ë‚´ ì ë“¤ì—ê²Œ ë°ë¯¸ì§€\n        let hitCount = 0;\n        this.game.enemies.children.entries.forEach(enemy => {\n            if (enemy.active) {\n                const distance = Phaser.Math.Distance.Between(x, y, enemy.x, enemy.y);\n                if (distance <= config.range) {\n                    // ë°ë¯¸ì§€ ì ìš©\n                    enemy.health -= config.damage;\n                    hitCount++;\n                    \n                    // ë°ë¯¸ì§€ í‘œì‹œ\n                    if (this.game.showDamageNumber) {\n                        this.game.showDamageNumber(enemy.x, enemy.y - 30, config.damage, 0xffff00);\n                    }\n                    \n                    // ê°ì „ íš¨ê³¼\n                    if (this.game.applyElectrifyEffect) {\n                        this.game.applyElectrifyEffect(enemy);\n                    }\n                    \n                    // ì  ì²˜ì¹˜ ì²˜ë¦¬\n                    if (enemy.health <= 0) {\n                        this.game.createExplosion(enemy.x, enemy.y);\n                        \n                        // ì—ë„ˆì§€ ì˜¤ë¸Œ ìƒì„±\n                        const energyOrb = this.game.physics.add.sprite(enemy.x, enemy.y, 'energy');\n                        this.game.energy.add(energyOrb);\n                        \n                        // ì ìˆ˜ ì¶”ê°€\n                        const points = this.game.getEnemyPoints ? this.game.getEnemyPoints(enemy.enemyType) : 100;\n                        this.game.score += points;\n                        \n                        enemy.destroy();\n                    }\n                }\n            }\n        });\n        \n        console.log(`âš¡ ë²ˆê°œ ë‚´ë¦¬ì¹˜ê¸° ì™„ë£Œ: ${hitCount}ë§ˆë¦¬ íƒ€ê²©`);\n    }\n    \n    // ë²ˆê°œ ë‚´ë¦¬ì¹˜ê¸° ì‹œê° íš¨ê³¼\n    createLightningStrikeEffect(x, y) {\n        // ë©”ì¸ ë²ˆê°œ ê¸°ë‘¥\n        const lightning = this.game.add.graphics();\n        lightning.lineStyle(6, 0xffff00, 1.0);\n        \n        // í•˜ëŠ˜ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” ë²ˆê°œ\n        const startY = y - 300;\n        const segments = 8;\n        const deviation = 25;\n        \n        let points = [{x: x, y: startY}];\n        \n        // ì§€ê·¸ì¬ê·¸ í¬ì¸íŠ¸ë“¤ ìƒì„±\n        for (let i = 1; i < segments; i++) {\n            const progress = i / segments;\n            const currentY = startY + (y - startY) * progress;\n            const randomX = x + (Math.random() - 0.5) * deviation * (1 - progress);\n            \n            points.push({x: randomX, y: currentY});\n        }\n        \n        points.push({x: x, y: y});\n        \n        // ë²ˆê°œ ê·¸ë¦¬ê¸°\n        lightning.beginPath();\n        lightning.moveTo(points[0].x, points[0].y);\n        for (let i = 1; i < points.length; i++) {\n            lightning.lineTo(points[i].x, points[i].y);\n        }\n        lightning.strokePath();\n        \n        // ê¸€ë¡œìš° íš¨ê³¼\n        const glow = this.game.add.graphics();\n        glow.lineStyle(15, 0x87ceeb, 0.4);\n        glow.beginPath();\n        glow.moveTo(points[0].x, points[0].y);\n        for (let i = 1; i < points.length; i++) {\n            glow.lineTo(points[i].x, points[i].y);\n        }\n        glow.strokePath();\n        \n        // íƒ€ê²© ì§€ì  í­ë°œ\n        const explosion = this.game.add.circle(x, y, 20, 0xffff00, 0.8);\n        \n        // ì• ë‹ˆë©”ì´ì…˜\n        this.game.tweens.add({\n            targets: [lightning, glow],\n            alpha: 0,\n            duration: 400,\n            onComplete: () => {\n                lightning.destroy();\n                glow.destroy();\n            }\n        });\n        \n        this.game.tweens.add({\n            targets: explosion,\n            scaleX: 3,\n            scaleY: 3,\n            alpha: 0,\n            duration: 500,\n            onComplete: () => explosion.destroy()\n        });\n        \n        // ìŠ¤íŒŒí¬ íŒŒí‹°í´\n        this.createSparkParticles(x, y, 15);\n    }\n    \n    // ìŠ¤íŒŒí¬ íŒŒí‹°í´ íš¨ê³¼\n    createSparkParticles(x, y, count = 10) {\n        for (let i = 0; i < count; i++) {\n            const particle = this.game.add.circle(x, y, 3, 0xffff00, 0.9);\n            \n            const angle = Math.random() * Math.PI * 2;\n            const speed = 50 + Math.random() * 100;\n            const distance = 30 + Math.random() * 50;\n            \n            this.game.tweens.add({\n                targets: particle,\n                x: x + Math.cos(angle) * distance,\n                y: y + Math.sin(angle) * distance,\n                alpha: 0,\n                scaleX: 0.2,\n                scaleY: 0.2,\n                duration: 300 + Math.random() * 300,\n                ease: 'Power2.easeOut',\n                onComplete: () => particle.destroy()\n            });\n        }\n    }\n    \n    // ì „ê¸° ì²´ì¸ í™œì„±í™” í‘œì‹œ\n    showElectricChainActivation(x, y, level) {\n        const text = this.game.add.text(x, y - 50, `ì „ê¸° ì²´ì¸ Lv.${level}!`, {\n            fontSize: '16px',\n            color: '#00aaff',\n            stroke: '#000000',\n            strokeThickness: 2\n        }).setOrigin(0.5);\n        \n        this.game.tweens.add({\n            targets: text,\n            y: y - 80,\n            alpha: 0,\n            duration: 1000,\n            onComplete: () => text.destroy()\n        });\n    }\n    \n    // ëœë¤ ë²ˆê°œ í™œì„±í™” í‘œì‹œ\n    showRandomLightningActivation(level, duration) {\n        const text = this.game.add.text(this.game.player.x, this.game.player.y - 60, \n            `ì²œë‘¥ë²ˆê°œ Lv.${level} í™œì„±í™”!`, {\n            fontSize: '20px',\n            color: '#ffff00',\n            stroke: '#000000',\n            strokeThickness: 3\n        }).setOrigin(0.5);\n        \n        this.game.tweens.add({\n            targets: text,\n            y: this.game.player.y - 90,\n            alpha: 0,\n            duration: 1500,\n            onComplete: () => text.destroy()\n        });\n    }\n    \n    // ì •ë¦¬ ì‘ì—…\n    cleanup() {\n        if (this.activeRandomLightning) {\n            this.activeRandomLightning.destroy();\n            this.activeRandomLightning = null;\n        }\n    }\n}